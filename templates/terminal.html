{% extends "base.html" %}

{% block title %}Terminal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-terminal me-2"></i>Linux Terminal
                        </h5>
                        <small class="text-muted">Execute Linux commands safely with enhanced features</small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearTerminal()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showSystemMonitor()">
                            <i class="fas fa-chart-line"></i> Monitor
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportHistory()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="terminal-container" id="terminalOutput">
                    <div class="mb-2">
                        <span class="text-success">$</span> Welcome to the enhanced web terminal!
                    </div>
                    <div class="mb-2">
                        <span class="text-info">$</span> Type 'help' for available commands or use the quick command buttons below.
                    </div>
                    <div class="mb-2">
                        <span class="text-warning">$</span> Current directory: <span id="currentDir">{{ current_path }}</span>
                    </div>
                </div>
                <div class="p-3 border-top">
                    <div class="input-group">
                        <span class="input-group-text bg-dark text-success">
                            <i class="fas fa-terminal"></i>
                        </span>
                        <input type="text" class="form-control terminal-input" id="commandInput" 
                               placeholder="Enter command..." autocomplete="off">
                        <button class="btn btn-success" onclick="executeCommand()">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-warning" onclick="clearTerminal()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <!-- Command suggestions dropdown -->
                    <div id="commandSuggestions" class="dropdown-menu w-100" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- System Monitor -->
        <div class="card mt-4" id="systemMonitorCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>System Monitor
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 id="cpuUsage">0%</h4>
                            <small class="text-muted">CPU Usage</small>
                            <div class="progress mt-1">
                                <div class="progress-bar" id="cpuBar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 id="memoryUsage">0%</h4>
                            <small class="text-muted">Memory Usage</small>
                            <div class="progress mt-1">
                                <div class="progress-bar bg-success" id="memoryBar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 id="diskUsage">0%</h4>
                            <small class="text-muted">Disk Usage</small>
                            <div class="progress mt-1">
                                <div class="progress-bar bg-warning" id="diskBar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 id="loadAverage">0.00</h4>
                            <small class="text-muted">Load Average</small>
                            <div class="progress mt-1">
                                <div class="progress-bar bg-info" id="loadBar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Commands -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Commands
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="runQuickCommand('pwd')">
                            <i class="fas fa-map-marker-alt me-1"></i>pwd
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="runQuickCommand('ls -la')">
                            <i class="fas fa-list me-1"></i>ls -la
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="runQuickCommand('df -h')">
                            <i class="fas fa-hdd me-1"></i>df -h
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="runQuickCommand('free -h')">
                            <i class="fas fa-memory me-1"></i>free -h
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100" onclick="runQuickCommand('whoami')">
                            <i class="fas fa-user me-1"></i>whoami
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100" onclick="runQuickCommand('uname -a')">
                            <i class="fas fa-info-circle me-1"></i>uname -a
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100" onclick="runQuickCommand('ps aux | head -10')">
                            <i class="fas fa-tasks me-1"></i>ps aux
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100" onclick="runQuickCommand('netstat -tuln | head -10')">
                            <i class="fas fa-network-wired me-1"></i>netstat
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-warning btn-sm w-100" onclick="runQuickCommand('top -n 1')">
                            <i class="fas fa-chart-bar me-1"></i>top
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-warning btn-sm w-100" onclick="runQuickCommand('du -sh .')">
                            <i class="fas fa-folder me-1"></i>du -sh
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-warning btn-sm w-100" onclick="runQuickCommand('find . -name "*.log" | head -5')">
                            <i class="fas fa-search me-1"></i>find logs
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-warning btn-sm w-100" onclick="runQuickCommand('grep -r "error" . --include="*.log" | head -5')">
                            <i class="fas fa-exclamation-triangle me-1"></i>grep errors
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Command History -->
        <div class="card mt-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>Command History
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="clearHistory()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                        <button class="btn btn-outline-primary" onclick="exportHistory()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="commandHistory" class="small">
                    <div class="text-muted">No commands executed yet.</div>
                </div>
            </div>
        </div>

        <!-- File Operations -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>File Operations
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" class="form-control" id="fileSearchInput" placeholder="Search files...">
                            <button class="btn btn-outline-secondary" onclick="searchFiles()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" class="form-control" id="grepPattern" placeholder="Grep pattern...">
                            <button class="btn btn-outline-secondary" onclick="grepFiles()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" class="form-control" id="fileSize" placeholder="File size (e.g., +1M)">
                            <button class="btn btn-outline-secondary" onclick="findBySize()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Monitor Modal -->
<div class="modal fade" id="systemMonitorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>System Monitor
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="systemMonitorContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let commandHistory = [];
let historyIndex = -1;
let systemMonitorInterval = null;

// Enhanced command suggestions
const commandSuggestions = {
    'ls': ['ls -la', 'ls -lh', 'ls -R', 'ls -t'],
    'find': ['find . -name "*.txt"', 'find . -size +1M', 'find . -mtime -7'],
    'grep': ['grep -r "pattern" .', 'grep -i "error" *.log', 'grep -v "debug" file.txt'],
    'ps': ['ps aux', 'ps -ef', 'ps aux | grep process'],
    'top': ['top', 'top -n 1', 'htop'],
    'df': ['df -h', 'df -i', 'du -sh .'],
    'netstat': ['netstat -tuln', 'netstat -an', 'ss -tuln'],
    'tar': ['tar -czf archive.tar.gz folder/', 'tar -xzf archive.tar.gz'],
    'chmod': ['chmod 755 file', 'chmod +x script.sh'],
    'chown': ['chown user:group file', 'chown -R user:group folder/']
};

// Initialize terminal
$(document).ready(function() {
    $('#commandInput').focus();
    
    // Handle Enter key
    $('#commandInput').keydown(function(e) {
        if (e.key === 'Enter') {
            executeCommand();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navigateHistory('up');
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateHistory('down');
        } else if (e.key === 'Tab') {
            e.preventDefault();
            autoComplete();
        }
    });

    // Auto-complete on input
    $('#commandInput').on('input', function() {
        showCommandSuggestions();
    });

    // Hide suggestions when clicking outside
    $(document).click(function(e) {
        if (!$(e.target).closest('#commandInput, #commandSuggestions').length) {
            $('#commandSuggestions').hide();
        }
    });
});

function executeCommand() {
    const command = $('#commandInput').val().trim();
    if (!command) return;

    // Add to history
    if (command !== commandHistory[commandHistory.length - 1]) {
        commandHistory.push(command);
    }
    historyIndex = commandHistory.length;

    // Display command
    appendToTerminal(`<span class="text-success">$</span> ${command}`);

    // Execute command
    $.ajax({
        url: '/api/execute-command',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ command: command }),
        success: function(response) {
            if (response.stdout) {
                appendToTerminal(`<div class="text-white">${response.stdout}</div>`);
            }
            if (response.stderr) {
                appendToTerminal(`<div class="text-danger">${response.stderr}</div>`);
            }
            if (response.returncode !== 0) {
                appendToTerminal(`<div class="text-warning">Command exited with code ${response.returncode}</div>`);
            }
            
            // Update current directory
            if (response.cwd) {
                $('#currentDir').text(response.cwd);
            }
            
            updateCommandHistory();
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Unknown error occurred';
            appendToTerminal(`<div class="text-danger">Error: ${error}</div>`);
        }
    });

    $('#commandInput').val('');
    $('#commandInput').focus();
    $('#commandSuggestions').hide();
}

function runQuickCommand(command) {
    $('#commandInput').val(command);
    executeCommand();
}

function appendToTerminal(content) {
    const terminal = $('#terminalOutput');
    terminal.append(`<div class="mb-2">${content}</div>`);
    terminal.scrollTop(terminal[0].scrollHeight);
}

function clearTerminal() {
    $('#terminalOutput').html(`
        <div class="mb-2">
            <span class="text-success">$</span> Terminal cleared.
        </div>
    `);
}

function navigateHistory(direction) {
    if (commandHistory.length === 0) return;

    if (direction === 'up') {
        if (historyIndex > 0) {
            historyIndex--;
        }
    } else if (direction === 'down') {
        if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
        } else {
            historyIndex = commandHistory.length;
        }
    }

    if (historyIndex < commandHistory.length) {
        $('#commandInput').val(commandHistory[historyIndex]);
    } else {
        $('#commandInput').val('');
    }
}

function updateCommandHistory() {
    const historyDiv = $('#commandHistory');
    if (commandHistory.length === 0) {
        historyDiv.html('<div class="text-muted">No commands executed yet.</div>');
        return;
    }

    let historyHtml = '';
    const recentCommands = commandHistory.slice(-15).reverse();
    recentCommands.forEach((cmd, index) => {
        historyHtml += `
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="text-monospace">${cmd}</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="runQuickCommand('${cmd}')">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('${cmd}')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        `;
    });
    historyDiv.html(historyHtml);
}

function showCommandSuggestions() {
    const input = $('#commandInput').val();
    if (input.length < 2) {
        $('#commandSuggestions').hide();
        return;
    }

    const suggestions = [];
    const words = input.split(' ');
    const baseCommand = words[0];

    // Add command suggestions
    for (const [cmd, variants] of Object.entries(commandSuggestions)) {
        if (cmd.startsWith(baseCommand)) {
            suggestions.push(...variants);
        }
    }

    // Add common commands
    const commonCommands = [
        'ls -la', 'cd ..', 'pwd', 'mkdir folder', 'rm file',
        'cp source dest', 'mv old new', 'cat file', 'head file', 'tail file',
        'grep pattern file', 'find . -name "*.txt"', 'chmod 755 file'
    ];

    commonCommands.forEach(cmd => {
        if (cmd.startsWith(input)) {
            suggestions.push(cmd);
        }
    });

    if (suggestions.length > 0) {
        let suggestionsHtml = '';
        suggestions.slice(0, 8).forEach(suggestion => {
            suggestionsHtml += `
                <a class="dropdown-item" href="#" onclick="selectSuggestion('${suggestion}')">
                    ${suggestion}
                </a>
            `;
        });
        $('#commandSuggestions').html(suggestionsHtml).show();
    } else {
        $('#commandSuggestions').hide();
    }
}

function selectSuggestion(suggestion) {
    $('#commandInput').val(suggestion);
    $('#commandSuggestions').hide();
    $('#commandInput').focus();
}

function autoComplete() {
    const input = $('#commandInput').val();
    const words = input.split(' ');
    const baseCommand = words[0];

    // Find matching command
    for (const cmd of Object.keys(commandSuggestions)) {
        if (cmd.startsWith(baseCommand) && cmd !== baseCommand) {
            const newWords = [...words];
            newWords[0] = cmd;
            $('#commandInput').val(newWords.join(' '));
            return;
        }
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const btn = event.target.closest('button');
        const originalIcon = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            btn.innerHTML = originalIcon;
        }, 1000);
    });
}

function clearHistory() {
    commandHistory = [];
    historyIndex = -1;
    updateCommandHistory();
}

function exportHistory() {
    if (commandHistory.length === 0) {
        alert('No commands to export');
        return;
    }

    const historyText = commandHistory.join('\n');
    const blob = new Blob([historyText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'terminal_history.txt';
    a.click();
    URL.revokeObjectURL(url);
}

function showSystemMonitor() {
    $('#systemMonitorCard').toggle();
    if ($('#systemMonitorCard').is(':visible')) {
        startSystemMonitoring();
    } else {
        stopSystemMonitoring();
    }
}

function startSystemMonitoring() {
    if (systemMonitorInterval) return;
    
    systemMonitorInterval = setInterval(() => {
        $.ajax({
            url: '/api/system-info',
            method: 'GET',
            success: function(response) {
                $('#cpuUsage').text(response.cpu_percent + '%');
                $('#cpuBar').css('width', response.cpu_percent + '%');
                
                $('#memoryUsage').text(response.memory.percent + '%');
                $('#memoryBar').css('width', response.memory.percent + '%');
                
                $('#diskUsage').text(response.disk.percent + '%');
                $('#diskBar').css('width', response.disk.percent + '%');
                
                // Simulate load average (you can implement real load average)
                const load = (response.cpu_percent / 100).toFixed(2);
                $('#loadAverage').text(load);
                $('#loadBar').css('width', (load * 100) + '%');
            }
        });
    }, 2000);
}

function stopSystemMonitoring() {
    if (systemMonitorInterval) {
        clearInterval(systemMonitorInterval);
        systemMonitorInterval = null;
    }
}

function searchFiles() {
    const pattern = $('#fileSearchInput').val();
    if (!pattern) {
        alert('Please enter a search pattern');
        return;
    }
    
    const command = `find . -name "*${pattern}*" -type f | head -20`;
    $('#commandInput').val(command);
    executeCommand();
}

function grepFiles() {
    const pattern = $('#grepPattern').val();
    if (!pattern) {
        alert('Please enter a grep pattern');
        return;
    }
    
    const command = `grep -r "${pattern}" . --include="*.txt" --include="*.log" --include="*.py" | head -20`;
    $('#commandInput').val(command);
    executeCommand();
}

function findBySize() {
    const size = $('#fileSize').val();
    if (!size) {
        alert('Please enter a file size');
        return;
    }
    
    const command = `find . -size ${size} -type f | head -20`;
    $('#commandInput').val(command);
    executeCommand();
}

// Keyboard shortcuts
$(document).keydown(function(e) {
    if (e.ctrlKey && e.key === 'l') {
        e.preventDefault();
        clearTerminal();
    } else if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        $('#commandInput').val('');
    } else if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        $('#commandInput').focus();
    }
});

// Cleanup on page unload
$(window).on('beforeunload', function() {
    stopSystemMonitoring();
});
</script>
{% endblock %} 